{% extends "base.html" %}

{% block title %}Performance Summary{% endblock %}

{% block content %}
<h1 class="mb-4">Performance Summary</h1>

<!-- Table container for responsiveness -->
<div class="table-responsive">
    <table class="table table-striped bg-white table-bordered table-sm">
        <thead>
            <tr>
                <th>Shop</th>
                <th>Total Cash In</th>
                <th>Total Till In</th>
                <th>Total Cash Out</th>
                <th>Total Till Out</th>
                <th>Total Cash</th>
            </tr>
        </thead>
        <tbody>
            {% for data in shop_data %}
                <tr>
                    <td>{{ data.shop }}</td>
                    <td class="text-right text-success">KSH {{ data.total_cash_in|floatformat:2 }}</td>
                    <td class="text-right text-success">KSH {{ data.total_till_in|floatformat:2 }}</td>
                    <td class="text-right text-danger">KSH {{ data.total_cash_out|floatformat:2 }}</td>
                    <td class="text-right text-danger">KSH {{ data.total_till_out|floatformat:2 }}</td>
                    <td class="text-right {% if data.total_cash < 0 %}text-danger{% else %}text-success{% endif %}">KSH {{ data.total_cash|floatformat:2 }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mt-4">
    <h2 class="mb-3">Key Performance Indicators (KPIs)</h2>
    <div class="row">
        {% for data in shop_data %}
            <div class="col-md-4 mb-4">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">{{ data.shop }}</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text"><strong>Average Sales per Day:</strong> KSH {{ data.average_sales_per_day|floatformat:2 }}</p>
                        <p class="card-text"><strong>Sales to Target Ratio:</strong> {{ data.sales_to_target_ratio }}%</p>
                        <p class="card-text"><strong>Profit Margin:</strong> {{ data.profit_margin }}%</p>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Performance Trends -->
<div class="mt-4">
    <h2>Performance Trends</h2>
    <div class="chart-container" style="width: 100%; max-width: 500px; margin: 0 auto;">
        <canvas id="performanceTrends" width="500" height="250"></canvas>
    </div>
</div>

<!-- Include Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var ctx = document.getElementById('performanceTrends').getContext('2d');
    var chartData = {{ chart_data|safe }};
    var myChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            var label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += 'KSH ' + context.parsed.y.toFixed(2);
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Month'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Sales (KSH)'
                    }
                }
            }
        }
    });
</script>

<!-- Alerts Section -->
{% if alerts %}
    <div class="alert alert-warning mt-4">
        <h4 class="alert-heading">Alerts</h4>
        <ul>
            {% for alert in alerts %}
                <li>{{ alert }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

{% endblock %}
